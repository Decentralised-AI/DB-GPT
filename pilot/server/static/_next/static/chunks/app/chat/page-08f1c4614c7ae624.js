(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[929],{84380:function(e,t,r){Promise.resolve().then(r.bind(r,65641))},65641:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return F}});var a=r(9268),l=r(89081),n=r(78915),s=r(45642),i=r(62414),o=r(26974),c=r(22046),d=r(83192),u=r(71990),h=r(86006),x=e=>{let t=(0,h.useReducer)((e,t)=>({...e,...t}),{...e});return t},f=r(57931),v=r(52040),m=e=>{let{queryAgentURL:t,channel:r,queryBody:a,initHistory:l}=e,[n,s]=x({history:l||[]}),{refreshDialogList:i}=(0,f.Cg)();(0,h.useEffect)(()=>{l&&s({history:l})},[l]);let o=async(e,l)=>{if(!e)return;let o=[...n.history,{role:"human",context:e}],c=o.length;s({history:o});try{let n=new AbortController;await (0,u.L)("".concat(v.env.API_BASE_URL?v.env.API_BASE_URL:"").concat("/api"+t),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...l,...a,user_input:e,channel:r}),signal:n.signal,async onopen(e){if(o.length<=1){i();let e=new URLSearchParams(window.location.search);e.delete("initMessage"),window.history.replaceState(null,null,"?".concat(e.toString()))}(!e.ok||e.headers.get("content-type")!==u.a)&&e.status>=400&&e.status<500&&429!==e.status&&e.status},onclose(){console.log("onclose")},onerror(e){throw Error(e)},onmessage:e=>{var t;if(e.data=e.data.replaceAll("\\n","\n"),"[DONE]"===e.data)n.abort();else if(null===(t=e.data)||void 0===t?void 0:t.startsWith("[ERROR]"))n.abort(),s({history:[...o,{role:"view",context:e.data.replace("[ERROR]","")}]});else{let t=[...o];e.data&&((null==t?void 0:t[c])?t[c].context="".concat(e.data):t.push({role:"view",context:e.data}),s({history:t}))}}})}catch(e){console.log(e),s({history:[...o,{role:"view",context:"请求出错"}]})}};return{handleChatSubmit:o,history:n.history}},p=r(67830),g=r(54842),j=r(80937),y=r(90545),w=r(94244),b=r(96159),Z=r(7354),N=r(35086),_=r(53047),P=r(19700),S=r(92391),k=r(55749),O=r(70781),R=r(75403),C=r(99398),E=r(49064),I=r(56008);let A=S.z.object({query:S.z.string().min(1)});var B=e=>{var t;let{messages:r,onSubmit:l,readOnly:n,paramsList:s,clearIntialMessage:o}=e,c=(0,I.useSearchParams)(),d=c.get("initMessage"),u=h.useRef(null),[x,f]=(0,h.useState)(!1),[v,m]=(0,h.useState)(),S=(0,P.cI)({resolver:(0,p.F)(A),defaultValues:{}}),B=async e=>{let{query:t}=e;try{console.log("submit"),f(!0),S.reset(),await l(t,{select_param:null==s?void 0:s[v]})}catch(e){}finally{f(!1)}},L=async()=>{try{let e=new URLSearchParams(window.location.search),t=e.get("initMessage");e.delete("initMessage"),window.history.replaceState(null,null,"?".concat(e.toString())),await B({query:t})}catch(e){console.log(e)}finally{null==o||o()}},T={overrides:{code:e=>{let{children:t}=e;return(0,a.jsx)(C.Z,{language:"javascript",style:E.Z,children:t})}},wrapper:h.Fragment};return h.useEffect(()=>{u.current&&u.current.scrollTo(0,u.current.scrollHeight)},[null==r?void 0:r.length]),h.useEffect(()=>{d&&r.length<=0&&L()},[d,r.length]),h.useEffect(()=>{var e,t;s&&(null===(e=Object.keys(s||{}))||void 0===e?void 0:e.length)>0&&m(null===(t=Object.keys(s||{}))||void 0===t?void 0:t[0])},[s]),(0,a.jsx)("div",{className:"w-full h-full",children:(0,a.jsxs)(j.Z,{className:"w-full h-full bg-[#fefefe] dark:bg-[#212121]",sx:{table:{borderCollapse:"collapse",border:"1px solid #ccc",width:"100%"},"th, td":{border:"1px solid #ccc",padding:"10px",textAlign:"center"}},children:[(0,a.jsxs)(j.Z,{ref:u,direction:"column",sx:{overflowY:"auto",maxHeight:"100%",flex:1},children:[null===(t=r.filter(e=>["view","human"].includes(e.role)))||void 0===t?void 0:t.map((e,t)=>{var r;return(0,a.jsx)(j.Z,{children:(0,a.jsx)(i.Z,{size:"sm",variant:"outlined",color:"view"===e.role?"primary":"neutral",sx:t=>({background:"view"===e.role?"var(--joy-palette-primary-softBg, var(--joy-palette-primary-100, #DDF1FF))":"unset",border:"unset",borderRadius:"unset",padding:"24px 0 26px 0",lineHeight:"24px"}),children:(0,a.jsxs)(y.Z,{sx:{width:"76%",margin:"0 auto"},className:"flex flex-row",children:[(0,a.jsx)("div",{className:"mr-3 inline",children:"view"===e.role?(0,a.jsx)(O.Z,{}):(0,a.jsx)(k.Z,{})}),(0,a.jsx)("div",{className:"inline align-middle mt-0.5 max-w-full flex-1 overflow-auto",children:(0,a.jsx)(R.Z,{options:T,children:null===(r=e.context)||void 0===r?void 0:r.replaceAll("\\n","\n")})})]})})},t)}),x&&(0,a.jsx)(w.Z,{variant:"soft",color:"neutral",size:"sm",sx:{mx:"auto",my:2}})]}),!n&&(0,a.jsx)(y.Z,{className:"bg-[#fefefe] dark:bg-[#212121] before:bg-[#fefefe] before:dark:bg-[#212121]",sx:{position:"relative","&::before":{content:'" "',position:"absolute",top:"-18px",left:"0",right:"0",width:"100%",margin:"0 auto",height:"20px",filter:"blur(10px)",zIndex:2}},children:(0,a.jsxs)("form",{style:{maxWidth:"100%",width:"76%",position:"relative",display:"flex",marginTop:"auto",overflow:"visible",background:"none",justifyContent:"center",marginLeft:"auto",marginRight:"auto",flexDirection:"column",gap:"12px",paddingBottom:"58px",paddingTop:"20px"},onSubmit:e=>{e.stopPropagation(),S.handleSubmit(B)(e)},children:[Object.keys(s||{}).length>0&&(0,a.jsx)("div",{className:"flex items-center gap-3",children:(0,a.jsx)(b.Z,{value:v,onChange:(e,t)=>{m(t)},sx:{maxWidth:"100%"},children:Object.keys(s||{}).map(e=>(0,a.jsx)(Z.Z,{value:e,children:e},e))})}),(0,a.jsx)(N.ZP,{className:"w-full h-12",variant:"outlined",endDecorator:(0,a.jsx)(_.ZP,{type:"submit",disabled:x,children:(0,a.jsx)(g.Z,{})}),...S.register("query")})]})})]})})},L=r(91440),T=r(84835),D=r.n(T),F=()=>{let e=(0,I.useSearchParams)(),{refreshDialogList:t}=(0,f.Cg)(),r=e.get("id"),u=e.get("scene"),{data:x}=(0,l.Z)(async()=>await (0,n.Tk)("/v1/chat/dialogue/messages/history",{con_uid:r}),{ready:!!r,refreshDeps:[r]}),{data:v}=(0,l.Z)(async()=>await (0,n.Kw)("/v1/chat/mode/params/list?chat_mode=".concat(u)),{ready:!!u,refreshDeps:[r,u]}),{history:p,handleChatSubmit:g}=m({queryAgentURL:"/v1/chat/completions",queryBody:{conv_uid:r,chat_mode:u||"chat_normal"},initHistory:null==x?void 0:x.data}),j=(0,h.useMemo)(()=>{try{var e;let t=null==p?void 0:null===(e=p[p.length-1])||void 0===e?void 0:e.context,r=JSON.parse(t);return(null==r?void 0:r.template_name)==="sales_report"?null==r?void 0:r.charts:void 0}catch(e){return}},[p]),y=(0,h.useMemo)(()=>{if(j){let e=[],t=null==j?void 0:j.filter(e=>"IndicatorValue"===e.chart_type);t.length>0&&e.push({rowIndex:e.length,cols:t,type:"IndicatorValue"});let r=null==j?void 0:j.filter(e=>"IndicatorValue"!==e.chart_type),a=r.length,l=0;return[[0],[1],[2],[1,2],[1,3],[2,1,2],[2,1,3],[3,1,3],[3,2,3]][a].forEach(t=>{if(t>0){let a=r.slice(l,l+t);l+=t,e.push({rowIndex:e.length,cols:a})}}),e}},[j]);return(0,a.jsxs)(s.Z,{container:!0,spacing:2,className:"h-full",sx:{flexGrow:1},children:[j&&(0,a.jsx)(s.Z,{xs:8,className:"max-h-full",children:(0,a.jsx)("div",{className:"flex flex-col gap-3 h-full",children:null==y?void 0:y.map(e=>(0,a.jsx)("div",{className:"".concat((null==e?void 0:e.type)!=="IndicatorValue"?"flex flex-1 gap-3 overflow-hidden":""),children:e.cols.map(e=>{if("IndicatorValue"===e.chart_type)return(0,a.jsx)("div",{className:"flex flex-row gap-3",children:e.values.map(e=>(0,a.jsx)("div",{className:"flex-1",children:(0,a.jsx)(i.Z,{children:(0,a.jsxs)(o.Z,{className:"justify-around",children:[(0,a.jsx)(c.ZP,{gutterBottom:!0,component:"div",children:e.name}),(0,a.jsx)(c.ZP,{children:e.value})]})})},e.name))},e.chart_uid);if("LineChart"===e.chart_type)return(0,a.jsx)("div",{className:"flex-1 overflow-hidden",children:(0,a.jsx)(i.Z,{className:"h-full",children:(0,a.jsxs)(o.Z,{className:"h-full",children:[(0,a.jsx)(c.ZP,{gutterBottom:!0,component:"div",children:e.chart_name}),(0,a.jsx)("div",{className:"flex-1 h-full",children:(0,a.jsx)(L.Chart,{padding:[10,20,50,40],autoFit:!0,data:e.values,children:(0,a.jsx)(L.LineAdvance,{shape:"smooth",point:!0,area:!0,position:"name*value",color:"type"})})})]})})},e.chart_uid);if("BarChart"===e.chart_type)return(0,a.jsx)("div",{className:"flex-1",children:(0,a.jsx)(i.Z,{className:"h-full",children:(0,a.jsxs)(o.Z,{className:"h-full",children:[(0,a.jsx)(c.ZP,{gutterBottom:!0,component:"div",children:e.chart_name}),(0,a.jsx)("div",{className:"flex-1",children:(0,a.jsxs)(L.Chart,{autoFit:!0,data:e.values,children:[(0,a.jsx)(L.Interval,{position:"name*value",style:{lineWidth:3,stroke:(0,L.getTheme)().colors10[0]}}),(0,a.jsx)(L.Tooltip,{shared:!0})]})})]})})},e.chart_uid);if("Table"===e.chart_type){var t,r;let l=D().groupBy(e.values,"type");return(0,a.jsx)("div",{className:"flex-1",children:(0,a.jsx)(i.Z,{className:"h-full overflow-auto",children:(0,a.jsxs)(o.Z,{className:"h-full",children:[(0,a.jsx)(c.ZP,{gutterBottom:!0,component:"div",children:e.chart_name}),(0,a.jsx)("div",{className:"flex-1",children:(0,a.jsxs)(d.Z,{"aria-label":"basic table",stripe:"odd",hoverRow:!0,borderAxis:"bothBetween",children:[(0,a.jsx)("thead",{children:(0,a.jsx)("tr",{children:Object.keys(l).map(e=>(0,a.jsx)("th",{children:e},e))})}),(0,a.jsx)("tbody",{children:null===(t=Object.values(l))||void 0===t?void 0:null===(r=t[0])||void 0===r?void 0:r.map((e,t)=>{var r;return(0,a.jsx)("tr",{children:null===(r=Object.keys(l))||void 0===r?void 0:r.map(e=>{var r;return(0,a.jsx)("td",{children:(null==l?void 0:null===(r=l[e])||void 0===r?void 0:r[t].value)||""},e)})},t)})})]})})]})})},e.chart_uid)}})},e.rowIndex))})}),(0,a.jsx)(s.Z,{xs:j?4:12,className:"h-full max-h-full",children:(0,a.jsx)("div",{className:"h-full",style:{boxShadow:j?"0px 0px 9px 0px #c1c0c080":"unset"},children:(0,a.jsx)(B,{clearIntialMessage:async()=>{await t()},messages:p||[],onSubmit:g,paramsList:null==v?void 0:v.data})})})]})}},57931:function(e,t,r){"use strict";r.d(t,{ZP:function(){return c},Cg:function(){return i}});var a=r(9268),l=r(89081),n=r(78915),s=r(86006);let[i,o]=function(){let e=s.createContext(void 0);return[function(){let t=s.useContext(e);if(void 0===t)throw Error("useCtx must be inside a Provider with a value");return t},e.Provider]}();var c=e=>{let{children:t}=e,{run:r,data:s,refresh:i}=(0,l.Z)(async()=>await (0,n.Tk)("/v1/chat/dialogue/list"),{manual:!0});return(0,a.jsx)(o,{value:{dialogueList:s,queryDialogueList:r,refreshDialogList:i},children:t})}},78915:function(e,t,r){"use strict";r.d(t,{Tk:function(){return d},Kw:function(){return u},PR:function(){return h},Ej:function(){return x}});var a=r(21628),l=r(24214),n=r(52040);let s=l.Z.create({baseURL:n.env.API_BASE_URL});s.defaults.timeout=1e4,s.interceptors.response.use(e=>e.data,e=>Promise.reject(e));var i=r(84835);let o={"content-type":"application/json"},c=e=>{if(!(0,i.isPlainObject)(e))return JSON.stringify(e);let t={...e};for(let e in t){let r=t[e];"string"==typeof r&&(t[e]=r.trim())}return JSON.stringify(t)},d=(e,t)=>{if(t){let r=Object.keys(t).filter(e=>void 0!==t[e]&&""!==t[e]).map(e=>"".concat(e,"=").concat(t[e])).join("&");r&&(e+="?".concat(r))}return s.get("/api"+e,{headers:o}).then(e=>e).catch(e=>{a.ZP.error(e),Promise.reject(e)})},u=(e,t)=>{let r=c(t);return s.post("/api"+e,{body:r,headers:o}).then(e=>e).catch(e=>{a.ZP.error(e),Promise.reject(e)})},h=(e,t)=>(c(t),s.post(e,t,{headers:o}).then(e=>e).catch(e=>{a.ZP.error(e),Promise.reject(e)})),x=(e,t)=>s.post(e,t).then(e=>e).catch(e=>{a.ZP.error(e),Promise.reject(e)})}},function(e){e.O(0,[180,757,110,97,86,316,259,751,78,253,769,744],function(){return e(e.s=84380)}),_N_E=e.O()}]);